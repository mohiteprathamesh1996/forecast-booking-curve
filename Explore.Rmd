---
title: "Explore"
author: "Prathamesh Mohite"
date: "`r Sys.Date()`"
output: html_document
---


# Data Cleaning

```{r}
library(dplyr)
library(ggplot2)
library(scales)
library(tidyr)
library(readr)
library(forecast)
library(prophet)
library(modeltime)
library(tidymodels)
library(tidyverse)
library(timetk)
library(lubridate)
library(timeDate)
library(gridExtra)
library(mgcv)
library(imputeTS)
library(zoo)
library(furrr)
library(Metrics)
library(MLmetrics)
library(openai)

# Load dataset (Historical booking curves)
dataset <- read.csv("data/dataset.csv") %>%
  mutate(departure_Date = as.Date(departure_Date)) %>%
  arrange(departure_Date)

# Load dataset (Flights needing forecast)
output <- read.csv("data/output.csv") %>%
  mutate(departure_Date = as.Date(departure_Date)) %>%
  arrange(departure_Date)

# Compute pickup
weekend_definition <- c("Saturday", "Sunday")

pickup_info_weekend <- dataset %>%
  group_by(
    Origin_Destination,
    WeekendDeparture = ifelse(
      test = wday(departure_Date, label = TRUE, abbr = FALSE) %in% weekend_definition,
      yes = 1,
      no = 0
    )
  ) %>%
  summarise(
    .groups = "drop",
    across(-departure_Date, ~ round(mean(.x, na.rm = TRUE)),
      .names = "{.col}"
    )
  ) %>%
  ungroup() %>%
  mutate(
    across(
      -c(
        Origin_Destination,
        Target,
        WeekendDeparture
      ),
      ~ Target - .,
      .names = "{.col}"
    )
  ) %>%
  select(-Target) %>%
  pivot_longer(
    cols = starts_with("X"),
    names_to = "Days Before Departure",
    values_to = "AvgPickUp"
  ) %>%
  mutate(
    `Days Before Departure` = as.numeric(
      gsub("[^0-9]", "", `Days Before Departure`)
    )
  ) %>%
  drop_na()

# Reshaped dataset in long format for time-series analysis
dataset_long <- dataset %>%
  pivot_longer(
    cols = starts_with("X"),
    names_to = "Days Before Departure",
    values_to = "Seats Sold"
  ) %>%
  mutate(
    WeekendDeparture = ifelse(
      test = wday(departure_Date, label = TRUE, abbr = FALSE) %in% weekend_definition,
      yes = 1,
      no = 0
    ),
    `Days Before Departure` = as.numeric(
      gsub("[^0-9]", "", `Days Before Departure`)
    )
  ) %>%
  group_by(departure_Date, Origin_Destination) %>%
  filter(
    `Days Before Departure` <= max(
      `Days Before Departure`[!is.na(`Seats Sold`)],
      na.rm = TRUE
    )
  ) %>%
  mutate(
    `Seats Sold` = round(ifelse(
      test = is.na(`Seats Sold`),
      yes = (lead(`Seats Sold`) + lag(`Seats Sold`)) / 2,
      no = `Seats Sold`
    ))
  ) %>%
  mutate(`Seats Sold` = ifelse(`Seats Sold`<=0, 0, `Seats Sold`)) %>% 
  ungroup() %>%
  group_by(Origin_Destination, departure_Date) %>%
  arrange(
    Origin_Destination,
    departure_Date,
    `Days Before Departure`
  ) %>%  
  mutate(
    rolling_mean = rollmean(`Seats Sold`, k = 3, fill = NA, align = "right"),
    residual = `Seats Sold` - rolling_mean
  ) %>% 
  mutate(
    threshold = 2 * sd(residual, na.rm = TRUE)
    ) %>% 
  mutate(
    `Seats Sold Outliers Removed` = ifelse(
      residual > threshold & `Days Before Departure`>10, 
      NA, 
      `Seats Sold`
      )
  ) %>% 
  ungroup() %>% 
  mutate(
    DailyBookingRate = `Seats Sold Outliers Removed` - lead(`Seats Sold Outliers Removed`),
    BookingRateAccelaration = DailyBookingRate - lead(DailyBookingRate),
    PercentageTargetReached = `Seats Sold Outliers Removed` / Target
  ) %>%
  ungroup() %>%
  mutate(
    PercentageTargetReached = ifelse(
      PercentageTargetReached > 1, 1, PercentageTargetReached
    )
  ) %>%
  arrange(departure_Date, Origin_Destination, `Days Before Departure`) %>%
  group_by(departure_Date, Origin_Destination) %>%
  mutate(LF_PercentageTargetReached = lead(PercentageTargetReached)) %>%
  ungroup() %>%
  left_join(
    pickup_info_weekend,
    by = c("Origin_Destination", "Days Before Departure", "WeekendDeparture")
  )

output_long <- output %>%
  pivot_longer(
    cols = starts_with("X"),
    names_to = "Days Before Departure",
    values_to = "Seats Sold"
  ) %>%
  mutate(
    WeekendDeparture = ifelse(
      test = wday(departure_Date, label = TRUE, abbr = FALSE) %in% weekend_definition,
      yes = 1,
      no = 0
    ),
    `Days Before Departure` = as.numeric(
      gsub("[^0-9]", "", `Days Before Departure`)
    )
  ) %>%
  group_by(departure_Date, Origin_Destination) %>%
  filter(
    `Days Before Departure` >= min(
      `Days Before Departure`[!is.na(`Seats Sold`)],
      na.rm = TRUE
    )
  ) %>%
  mutate(
    `Seats Sold` = round(ifelse(
      test = is.na(`Seats Sold`),
      yes = (lead(`Seats Sold`) + lag(`Seats Sold`)) / 2,
      no = `Seats Sold`
    ))
  ) %>%
  mutate(`Seats Sold` = ifelse(`Seats Sold`<=0, 0, `Seats Sold`)) %>%
  ungroup() %>%
  group_by(Origin_Destination, departure_Date) %>%
  arrange(
    Origin_Destination,
    departure_Date,
    `Days Before Departure`
  ) %>%
  mutate(
    DailyBookingRate = `Seats Sold` - lag(`Seats Sold`),
    BookingRateAccelaration = DailyBookingRate - lag(DailyBookingRate),
    PercentageTargetReached = `Seats Sold` / Target
  ) %>%
  ungroup() %>%
  mutate(
    PercentageTargetReached = ifelse(
      PercentageTargetReached > 1, 1, PercentageTargetReached
    )
  ) %>%
  arrange(departure_Date, Origin_Destination, `Days Before Departure`) %>%
  group_by(departure_Date, Origin_Destination) %>%
  mutate(LF_PercentageTargetReached = lead(PercentageTargetReached)) %>%
  ungroup() %>%
  drop_na() %>%
  left_join(
    pickup_info_weekend,
    by = c("Origin_Destination", "Days Before Departure", "WeekendDeparture")
  ) %>%
  mutate(
    `Traditional Pick-Up Forecast` = `Seats Sold` + AvgPickUp
  )

# historical_summary <- dataset_long %>%
#   group_by(Origin_Destination, `Days Before Departure`) %>%
#   summarise(
#     .groups = "drop",
#     DailyBookingRate = mean(DailyBookingRate, na.rm = TRUE),
#     BookingRateAccelaration = mean(BookingRateAccelaration, na.rm = TRUE),
#     PercentageTargetReached = mean(PercentageTargetReached, na.rm = TRUE),
#     LF_PercentageTargetReached = mean(LF_PercentageTargetReached, na.rm = TRUE),
#     AvgPickUp = mean(AvgPickUp, na.rm = TRUE)
#   ) %>%
#   ungroup() %>%
#   drop_na()

historical_summary_weekend <- dataset_long %>%
  mutate(
    WeekendDeparture = ifelse(
      test = wday(departure_Date, label = TRUE, abbr = FALSE) %in% weekend_definition,
      yes = 1,
      no = 0
    )
  ) %>%
  group_by(Origin_Destination, `Days Before Departure`, WeekendDeparture) %>%
  summarise(
    .groups = "drop",
    DailyBookingRate = mean(DailyBookingRate, na.rm = TRUE),
    BookingRateAccelaration = mean(BookingRateAccelaration, na.rm = TRUE),
    PercentageTargetReached = mean(PercentageTargetReached, na.rm = TRUE),
    LF_PercentageTargetReached = mean(LF_PercentageTargetReached, na.rm = TRUE),
    AvgPickUp = mean(AvgPickUp, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  drop_na()

# historical_summary %>% write.csv("historical_summary.csv")
```





```{r}
dataset %>%
  group_by(
    Origin_Destination,
    WeekendDeparture = ifelse(
      test = wday(departure_Date, label = TRUE, abbr = FALSE) %in% weekend_definition,
      yes = 1,
      no = 0
    )
  ) %>%
  summarise(
    .groups = "drop",
    across(-departure_Date, ~ round(mean(.x, na.rm = TRUE)),
      .names = "{.col}"
    )
  ) %>%
  ungroup()
```


```{r}
dataset %>%
  pivot_longer(
    cols = starts_with("X"),
    names_to = "Days Before Departure",
    values_to = "Seats Sold"
  ) %>%
  mutate(
    `Seats Sold` = ifelse(`Seats Sold`<=0, 0, `Seats Sold`),
    WeekendDeparture = ifelse(
      test = wday(departure_Date, label = TRUE, abbr = FALSE) %in% weekend_definition,
      yes = 1,
      no = 0
    ),
    `Days Before Departure` = as.numeric(
      gsub("[^0-9]", "", `Days Before Departure`)
    )
  ) %>% 
  ungroup() %>%
  group_by(Origin_Destination, departure_Date) %>%
  arrange(
    Origin_Destination,
    departure_Date,
    `Days Before Departure`
  ) %>%  
  mutate(
    rolling_mean = rollmean(`Seats Sold`, k = 3, fill = NA, align = "right"),
    residual = `Seats Sold` - rolling_mean
  ) %>% 
  mutate(
    threshold = 2 * sd(residual, na.rm = TRUE)
  ) %>% 
  mutate(
    `Seats Sold Outliers Removed` = ifelse(
      residual > threshold & `Days Before Departure`>10, 
      NA, 
      `Seats Sold`
    )
  ) %>% 
  ungroup() %>%
  mutate(`Seats Sold` = round(
    na_kalman(
      `Seats Sold`,
      model = "StructTS"
    )
  )) %>% 
  group_by(Origin_Destination, WeekendDeparture, `Days Before Departure`) %>% 
  summarise(MEAND = round(mean(`Seats Sold`))) %>% 
  mutate(
    `Days Before Departure` = paste(
      "X", 
      `Days Before Departure`, 
      "_SeatsSold_sum",
      sep = ""
      )
    ) %>% 
  pivot_wider(
    names_from = `Days Before Departure`, 
    values_from = MEAND
    ) %>% 
  ungroup() 
  mutate(
    across(
      -c(
        Origin_Destination,
        X0_SeatsSold_sum,
        WeekendDeparture
      ),
      ~ Target - .,
      .names = "{.col}"
    )
  ) %>%
  select(-Target) %>%
  pivot_longer(
    cols = starts_with("X"),
    names_to = "Days Before Departure",
    values_to = "AvgPickUp"
  ) %>%
  mutate(
    `Days Before Departure` = as.numeric(
      gsub("[^0-9]", "", `Days Before Departure`)
    )
  ) %>%
  drop_na()
```


```{r}
dataset %>% 
  group_by(
    Origin_Destination,
    WeekendDeparture = ifelse(
      test = wday(departure_Date, label = TRUE, abbr = FALSE) %in% weekend_definition,
      yes = 1,
      no = 0
    )
    ) %>% 
  summarise(
    .groups = "drop", 
    Target = round(mean(Target))
    ) %>% 
  left_join(
    dataset %>%
  pivot_longer(
    cols = starts_with("X"),
    names_to = "Days Before Departure",
    values_to = "Seats Sold"
  ) %>%
  mutate(
    `Seats Sold` = ifelse(`Seats Sold`<=0, 0, `Seats Sold`),
    WeekendDeparture = ifelse(
      test = wday(departure_Date, label = TRUE, abbr = FALSE) %in% weekend_definition,
      yes = 1,
      no = 0
    ),
    `Days Before Departure` = as.numeric(
      gsub("[^0-9]", "", `Days Before Departure`)
    )
  ) %>% 
  ungroup() %>%
  group_by(Origin_Destination, departure_Date) %>%
  arrange(
    Origin_Destination,
    departure_Date,
    `Days Before Departure`
  ) %>%  
  mutate(
    rolling_mean = rollmean(`Seats Sold`, k = 3, fill = NA, align = "right"),
    residual = `Seats Sold` - rolling_mean
  ) %>% 
  mutate(
    threshold = 2 * sd(residual, na.rm = TRUE)
  ) %>% 
  mutate(
    `Seats Sold Outliers Removed` = ifelse(
      residual > threshold & `Days Before Departure`>10, 
      NA, 
      `Seats Sold`
    )
  ) %>% 
  ungroup() %>%
  mutate(`Seats Sold` = round(
    na_kalman(
      `Seats Sold`,
      model = "StructTS"
    )
  )) %>% 
  group_by(Origin_Destination, WeekendDeparture, `Days Before Departure`) %>% 
  summarise(MEAND = round(mean(`Seats Sold`))) %>% 
  mutate(
    `Days Before Departure` = paste(
      "X", 
      `Days Before Departure`, 
      "_SeatsSold_sum",
      sep = ""
      )
    ) %>% 
  pivot_wider(
    names_from = `Days Before Departure`, 
    values_from = MEAND
    ) %>% 
  ungroup(),
    by = c("Origin_Destination", "WeekendDeparture")
  ) %>% 
  mutate(
    across(
      -c(
        Origin_Destination,
        X0_SeatsSold_sum,
        WeekendDeparture
      ),
      ~ Target - .,
      .names = "{.col}"
    )
  ) %>%
  select(-Target) %>%
  pivot_longer(
    cols = starts_with("X"),
    names_to = "Days Before Departure",
    values_to = "AvgPickUp"
  ) %>%
  mutate(
    `Days Before Departure` = as.numeric(
      gsub("[^0-9]", "", `Days Before Departure`)
    )
  ) %>%
  drop_na() %>% 
  mutate(
    AvgPickUp = ifelse(`Days Before Departure`==0, 0, AvgPickUp)
    )
```



```{r}
pickup_info_weekend %>% 
  filter(Origin_Destination=="DXB-XXX", `Days Before Departure`==0)
```











# Original Solution

```{r}
dep_date <- "2023-03-10"
route <- "DXB-XXX"


train <- output_long %>%
  filter(
    departure_Date == dep_date &
      Origin_Destination == route
  ) %>%
  mutate(
    `Date Before Departure` = departure_Date - days(`Days Before Departure`)
  ) %>%
  select(
    `Date Before Departure`,
    `Seats Sold`,
    DailyBookingRate,
    BookingRateAccelaration,
    PercentageTargetReached,
    LF_PercentageTargetReached,
    AvgPickUp
  ) %>%
  arrange(`Date Before Departure`) %>%
  drop_na()

# train <- train %>%
#   arrange(`Date Before Departure`) %>%
#   tail(round(1.00 * nrow(train)))

target_cap <- output_long %>%
  filter(
    departure_Date == dep_date &
      Origin_Destination == route
  ) %>%
  pull(Target) %>%
  unique()

days_ahead <- output_long %>%
  filter(
    departure_Date == dep_date &
      Origin_Destination == route
  ) %>%
  pull(`Days Before Departure`) %>%
  min()

splits <- time_series_split(
  data = train,
  assess = paste(round(0.20 * nrow(train)), "days"),
  cumulative = TRUE
)

model_arima <- arima_reg(
  # p (Autoregressive Order)
  non_seasonal_ar = 2,
  non_seasonal_differences = 1,
  non_seasonal_ma = 1
) %>%
  set_engine("auto_arima") %>%
  fit(
    `Seats Sold` ~ `Date Before Departure`,
    training(splits)
  )


model_prophet <- prophet_reg(
  growth = "logistic",
  logistic_cap = target_cap
) %>%
  set_engine("prophet") %>%
  fit(
    `Seats Sold` ~ `Date Before Departure`,
    training(splits)
  )

model_prophet_with_reg <- prophet_reg(
  growth = "logistic",
  season = "multiplicative",
  logistic_cap = target_cap,
  changepoint_num = 1
) %>%
  set_engine("prophet") %>%
  fit(
    `Seats Sold` ~ `Date Before Departure` + DailyBookingRate + LF_PercentageTargetReached,
    training(splits)
  )


# Modeltime table
model_tbl <- modeltime_table(
  model_arima,
  model_prophet,
  model_prophet_with_reg
)

# Calibrate models
calib_tbl <- model_tbl %>%
  modeltime_calibrate(testing(splits))

# Generate future dates for forecasting
future_data <- future_frame(
  .data = train,
  .date_var = `Date Before Departure`,
  .length_out = paste(days_ahead, "days")
) %>%
  mutate(
    `Days Before Departure` = as.integer(
      as.Date(dep_date) - `Date Before Departure`
    )
  ) %>%
  left_join(
    historical_summary_weekend %>%
      filter(
        WeekendDeparture == ifelse(
          test = wday(
            dep_date,
            label = TRUE,
            abbr = FALSE
          ) %in% weekend_definition,
          yes = 1,
          no = 0
        )
      ) %>%
      filter(Origin_Destination == route) %>%
      select(
        `Days Before Departure`,
        DailyBookingRate,
        BookingRateAccelaration,
        PercentageTargetReached,
        LF_PercentageTargetReached,
        AvgPickUp
      ),
    by = "Days Before Departure"
  )

calib_tbl %>% modeltime_accuracy()

advance_pickup_df <- output_long %>%
  filter(
    Origin_Destination == route &
      departure_Date == dep_date
  ) %>%
  filter(
    `Days Before Departure` == min(`Days Before Departure`, na.rm = TRUE)
  )


calib_tbl %>%
  modeltime_refit(
    data = train
  ) %>%
  modeltime_forecast(
    new_data = future_data,
    actual_data = train
  ) %>%
  rbind(
    data.frame(
      .model_id = rep(NA, days_ahead),
      .model_desc = rep("Traditional PickUp Model", days_ahead),
      .key = rep("prediction", days_ahead),
      .index = future_data %>% pull(`Date Before Departure`) %>% sort(),
      .value = seq(
        advance_pickup_df$`Seats Sold`,
        advance_pickup_df$`Traditional Pick-Up Forecast`,
        length.out = days_ahead
      ),
      .conf_lo = rep(NA, days_ahead),
      .conf_hi = rep(NA, days_ahead)
    )
  ) %>%
  mutate(
    .value = round(.value),
    # .value = ifelse(.value>target_cap, target_cap, round(.value)),
    .conf_lo = round(.conf_lo),
    .conf_hi = round(.conf_hi)
  ) %>%
  plot_modeltime_forecast(
    .x_lab = "Date before Departure",
    .y_lab = "Seats Sold",
    .title = paste(
      "Booking Curve for", route, "on", dep_date,
      paste("(Target =", target_cap, " seats)", sep = "")
    )
  )
```




